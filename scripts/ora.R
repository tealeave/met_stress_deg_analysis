# scripts/ora.R
# Purpose: Perform Over-Representation Analysis (ORA) on the gene lists
# generated by venn.R to answer the four key research questions.
# This script analyzes up- and down-regulated gene sets separately for
# Gene Ontology (GO) and KEGG pathways.
# --- UPDATED TO USE ENSEMBL IDs AND READ THE UNIVERSE FROM A DESEQ2 CSV ---

# --- 1. Load Libraries ---
# First-time installation:
# if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
# BiocManager::install(c("clusterProfiler", "org.Hs.eg.db", "enrichplot"))
# install.packages(c("here", "ggplot2", "dplyr", "readr"))

library(clusterProfiler)
library(org.Hs.eg.db) # Annotation database for Human
library(enrichplot)
library(here)
library(ggplot2)
library(dplyr)
library(readr)

# --- 2. Configuration ---
# Define significance thresholds for enrichment results
pvalue_cutoff <- 0.05
qvalue_cutoff <- 0.10

# Define directories
# Input directory is the output from venn.R
input_dir <- here("results", "venn_diagrams_analytical")
# Output directory for ORA results
output_dir <- here("results", "ora_analysis")
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

# --- 3. Define Gene Universe from DESeq2 Results ---
##! PATH UPDATED AS REQUESTED !##
# The "universe" is the background set of all genes tested for differential expression.
# We will build it from one of your result tables. Any of them can be used as the source.
universe_source_file <- here("results", "tables_csv", "293t_hcy_vs_met.csv")

if (!file.exists(universe_source_file)) {
  stop("CRITICAL: Universe source file not found. Please check the path.")
}

# Read the DESeq2 result file
deseq_results <- read.csv(universe_source_file)
# The first column contains the ENSEMBL IDs with isoform versions
universe_genes_raw <- deseq_results[, 1]

# **IMPORTANT**: Strip isoform versions from ENSEMBL IDs (e.g., from "ENSG00000227232.6" to "ENSG00000227232")
universe_genes <- gsub("\\..*$", "", universe_genes_raw)

# Convert universe from ENSEMBL to Entrez IDs for analysis
universe_entrez <- bitr(universe_genes, fromType="ENSEMBL", toType="ENTREZID", OrgDb="org.Hs.eg.db")$ENTREZID
print(paste("Loaded", length(universe_entrez), "genes into the background universe."))


# --- 4. Helper Function for ORA ---
# This function automates the process of running and saving ORA results

perform_ora <- function(gene_list, list_name, direction) {
  # gene_list: A vector of raw ENSEMBL IDs (with isoform versions)
  # list_name: A descriptive name for the list (e.g., "q1_common_parental")
  # direction: "up" or "down"

  if (length(gene_list) < 10) {
    print(paste("Skipping", list_name, direction, "- too few genes (", length(gene_list), ")"))
    return(NULL)
  }

  print(paste("--- Analyzing:", list_name, "(", toupper(direction), ") with", length(gene_list), "genes ---"))

  # **IMPORTANT**: Strip isoform versions from input gene list
  genes_clean <- gsub("\\..*$", "", gene_list)
  
  # Convert ENSEMBL IDs to Entrez IDs
  gene_entrez <- bitr(genes_clean, fromType="ENSEMBL", toType="ENTREZID", OrgDb="org.Hs.eg.db")$ENTREZID

  if (length(gene_entrez) == 0) {
    print("No genes could be mapped to Entrez IDs. Skipping.")
    return(NULL)
  }
  print(paste("Mapped", length(gene_entrez), "genes to Entrez IDs."))

  # ---------- Perform GO Enrichment (Biological Process) ----------
  go_results <- enrichGO(
    gene          = gene_entrez,
    universe      = universe_entrez,
    OrgDb         = org.Hs.eg.db,
    ont           = "BP", # Biological Process
    pAdjustMethod = "BH",
    pvalueCutoff  = pvalue_cutoff,
    qvalueCutoff  = qvalue_cutoff,
    readable      = TRUE # Translates EntrezIDs to symbols in the results table
  )

  if (!is.null(go_results) && nrow(go_results) > 0) {
    print(paste("Found", nrow(go_results), "significant GO terms."))
    write.csv(as.data.frame(go_results), file.path(output_dir, paste0(list_name, "_", direction, "_GO_results.csv")))
    p1 <- dotplot(go_results, showCategory=20) + labs(title = paste(list_name, direction, "GO Enrichment"))
    ggsave(file.path(output_dir, paste0(list_name, "_", direction, "_GO_dotplot.png")), p1, width=10, height=8)
    go_results_pairwise <- pairwise_termsim(go_results)
    p2 <- emapplot(go_results_pairwise, showCategory=30) + labs(title = paste(list_name, direction, "GO Enrichment Map"))
    ggsave(file.path(output_dir, paste0(list_name, "_", direction, "_GO_emapplot.png")), p2, width=10, height=10)
  } else {
    print("No significant GO terms found.")
  }

  # ---------- Perform KEGG Enrichment ----------
  kegg_results <- enrichKEGG(
    gene          = gene_entrez,
    universe      = universe_entrez,
    organism      = 'hsa', # Homo sapiens
    pAdjustMethod = "BH",
    pvalueCutoff  = pvalue_cutoff,
    qvalueCutoff  = qvalue_cutoff
  )

  if (!is.null(kegg_results) && nrow(kegg_results) > 0) {
    print(paste("Found", nrow(kegg_results), "significant KEGG pathways."))
    # Translate Entrez IDs to gene symbols for readability
    kegg_results <- setReadable(kegg_results, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
    write.csv(as.data.frame(kegg_results), file.path(output_dir, paste0(list_name, "_", direction, "_KEGG_results.csv")))
    p3 <- dotplot(kegg_results, showCategory=20) + labs(title = paste(list_name, direction, "KEGG Enrichment"))
    ggsave(file.path(output_dir, paste0(list_name, "_", direction, "_KEGG_dotplot.png")), p3, width=10, height=8)
  } else {
    print("No significant KEGG pathways found.")
  }
}

# --- 5. Run Analysis for Each Research Question ---

# Create a list of all analyses to run.
# NOTE: This assumes the .txt files from venn.R also contain ENSEMBL IDs.
analyses_to_run <- list(
  q1 = list(name = "q1_common_parental_response", question = "Q1: Common Parental Response"),
  q2 = list(name = "q2_maintained_core_response", question = "Q2: Maintained Core Response"),
  q3a = list(name = "q3_unique_to_r1_response", question = "Q3: Unique to R1 Response"),
  q3b = list(name = "q3_unique_to_r8_response", question = "Q3: Unique to R8 Response"),
  q4 = list(name = "q4_common_revertant_signature", question = "Q4: Common Revertant Baseline Signature")
)

# Loop through each analysis and each direction (up/down)
for (analysis in analyses_to_run) {
  for (direction in c("up", "down")) {
    
    # Construct the filename of the gene list
    gene_list_file <- file.path(input_dir, paste0(analysis$name, "_", direction, ".txt"))
    
    if (file.exists(gene_list_file)) {
      current_genes <- readr::read_lines(gene_list_file)
      perform_ora(
        gene_list = current_genes,
        list_name = analysis$name,
        direction = direction
      )
    } else {
      print(paste("File not found, skipping:", basename(gene_list_file)))
    }
  }
}

print("--- ORA analysis script finished. ---")
print(paste("Results are saved in:", output_dir))